function toggleModal(){fab.classList.toggle("modalOpen"),newJourneySection.classList.toggle("modalOpen")}function DisplayMessage(e,t){this.displayMessageEl=document.getElementsByClassName("display-message")[0],this.messageEl=document.getElementsByClassName("dm__message")[0],this.actionBTN=document.getElementsByClassName("dm__action")[0],this.dismissBTN=document.getElementsByClassName("dm__dismiss")[0],this._init(e,t)}function Loader(e){this._target=e,this._loader=document.createElement("div"),this._loader.classList.add("spinner"),this._loader.innerHTML='<div class="double-bounce1"></div>\t\t\t\t\t\t\t<div class="double-bounce2"></div>',this._init()}function IndexController(){this._dbPromise=this._setupDB(),this.showDefaultJourney()}function Journey(e,t){this._savedJourney=!1,t?this._savedJourney=t:e&&(this._fromCoordinates=e.fromCoordinates,this._toCoordinates=e.toCoordinates,this._fromName=e.fromName?"&fromName="+e.fromName:"",this._toName=e.toName?"&toName="+e.toName:"",this._fetchUrl="https://api.tfl.gov.uk/Journey/JourneyResults/"+this._fromCoordinates+"/to/"+this._toCoordinates+"?nationalSearch=True&timeIs=Departing&journeyPreference=LeastTime&mode=tube&walkingSpeed=Average&cyclePreference=None&alternativeCycle=False&alternativeWalking=False&applyHtmlMarkup=False&useMultiModalCall=False&walkingOptimization=False"+this._fromName+this._toName+"&app_id="+app_id+"&app_key="+app_key),this._init()}function FormController(e){this._form=e,this._setupForm(),this._form.addEventListener("submit",this._handleSubmit)}var app_id="1e55ad45",app_key="40c230d6c65288e70be34a738dcc6b91",fab=document.getElementsByClassName("fab")[0],newJourneySection=document.getElementsByClassName("new-journey")[0];fab.addEventListener("click",function(){toggleModal()}),DisplayMessage.prototype._toggle=function(){this.displayMessageEl.classList.toggle("open")},DisplayMessage.prototype._reset=function(){this.displayMessageEl.classList.remove("success","danger","open"),this.messageEl.innerHTML="",this.actionBTN.style.display=""},DisplayMessage.prototype.setupAction=function(e,t){!e|!t&&(this.actionBTN.style.display="none"),this.actionBTN.innerHTML=e,this.actionBTN.addEventListener("click",t)},DisplayMessage.prototype._init=function(e,t){this._reset(),this.displayMessageEl.classList.add(e),this.messageEl.innerHTML=t,this._toggle();var o=this;this.dismissBTN.addEventListener("click",function(){o._toggle()})},Loader.prototype._init=function(){this._target.innerHTML="",this._target.appendChild(this._loader)},Loader.prototype.remove=function(){this._target.removeChild(this._loader)},IndexController.prototype._setupDB=function(){return navigator.serviceWorker?idb.open("tplanr",2,function(e){switch(e.oldVersion){case 0:var t=e.createObjectStore("journeys",{keyPath:"departure_time"});case 1:var t=e.transaction.objectStore("journeys");t.createIndex("coordinates","coordinates")}}):Promise.resolve()},IndexController.prototype._registerServiceWorker=function(){return"serviceWorker"in navigator?(navigator.serviceWorker.register("./service-worker.js",{scope:"./"}).then(function(e){if(e.waiting)return void new DisplayMessage("success","There's a new verion of TubePlanr available! Click refresh to update").setupAction("Refresh",function(){e.waiting.postMessage({action:"skipWaiting"})})})["catch"](function(e){console.log("Service Worker Failed to Register",e)}),void navigator.serviceWorker.addEventListener("controllerchange",function(){window.location.reload()})):void new DisplayMessage("success","Your browser doesn't support all the cool features this application offers (like offline capabilities). Why not try using this app in Chrome?").setupAction("Get Chrome",function(){window.open("https://www.google.com/chrome/browser/mobile/index.html")})},IndexController.prototype._handleEmptyState=function(){toggleModal()},IndexController.prototype.showDefaultJourney=function(){var e=this;this._dbPromise.then(function(e){var t=e.transaction("journeys","readwrite"),o=t.objectStore("journeys");return o.getAll()}).then(function(t){return 0==t.length?(e._handleEmptyState(),Promise.reject()):void new Journey(null,t[t.length-1])})};var Controller=new IndexController;Journey.prototype._setupData=function(e,t){for(var o={coordinates:t._fromCoordinates+" - "+t._toCoordinates,departure_location:e.journeys[0].legs[0].departurePoint.commonName,arrival_location:e.journeys[0].legs[e.journeys[0].legs.length-1].arrivalPoint.commonName,departure_time:e.journeys[0].startDateTime,journeys:e.journeys},n=0;n<e.journeys.length;n++){var r=e.journeys[n];o.journeys[n].points=[],o.journeys[n].departure_location,o.journeys[n].arrival_location;for(var i=0;i<r.legs.length;i++){var a=r.legs[i];0!=i&&o.journeys[n].points.push(!0),0==i&&(o.journeys[n].departure_location=a.departurePoint.commonName),i==r.legs.length-1&&(o.journeys[n].arrival_location=a.arrivalPoint.commonName),"tube"===a.mode.id?o.journeys[n].legs[i].instruction.custom='Take the <span class="instruction__line">'+a.routeOptions[0].name+' Line</span> (in the direction of <span class="instruction__direction">'+a.routeOptions[0].directions[0]+'</span>) and get off at <span class="instruction__dest">'+a.arrivalPoint.commonName+"</span>":"walking"==a.mode.id&&(o.journeys[n].legs[i].instruction.custom='Walk to <span class="instruction__dest">'+a.arrivalPoint.commonName+"</span>")}}return o},Journey.prototype._fetchData=function(){return fetch(this._fetchUrl).then(function(e){return e.json()})["catch"](function(e){return Promise.reject(e)})},Journey.prototype._clearDB=function(e){var t=e.coordinates;return Controller._dbPromise.then(function(e){var t=e.transaction("journeys","readwrite"),o=t.objectStore("journeys"),n=o.index("coordinates");return n.openCursor()}).then(function o(e){if(e)return e.value.coordinates===t&&e["delete"](),e["continue"]().then(o)}).then(function(){return Promise.resolve()})},Journey.prototype._addToDB=function(e,t){return t._clearDB(e).then(function(){return Controller._dbPromise.then(function(t){var o=t.transaction("journeys","readwrite"),n=o.objectStore("journeys");return n.put(e),o.complete}).then(function(){})})},Journey.prototype._displayJourney=function(e){var t=MyApp.templates.journeys(e);return document.getElementById("journeys").innerHTML=t,Promise.resolve(e)},Journey.prototype._checkJourneyInDB=function(e){var t=e._fromCoordinates+" - "+e._toCoordinates;return Controller._dbPromise.then(function(e){var o=e.transaction("journeys"),n=o.objectStore("journeys"),r=n.index("coordinates");return r.getAll(t)})},Journey.prototype._updateInBackground=function(e,t){var o=e.journeys[0].legs[0].departurePoint,n=e.journeys[0].legs[e.journeys[0].legs.length-1].arrivalPoint,r={fromCoordinates:o.lat+","+o.lon,toCoordinates:n.lat+","+n.lon,fromName:e.departure_location,toName:e.arrival_location};t._fromCoordinates=r.fromCoordinates,t._toCoordinates=r.toCoordinates,t._fromName=r.fromName?"&fromName="+r.fromName:"",t._toName=r.toName?"&toName="+r.toName:"",t._fetchUrl="https://api.tfl.gov.uk/Journey/JourneyResults/"+t._fromCoordinates+"/to/"+t._toCoordinates+"?nationalSearch=True&timeIs=Departing&journeyPreference=LeastTime&mode=tube&walkingSpeed=Average&cyclePreference=None&alternativeCycle=False&alternativeWalking=False&applyHtmlMarkup=False&useMultiModalCall=False&walkingOptimization=False"+t._fromName+t._toName+"&app_id="+app_id+"&app_key="+app_key,t._fetchAndDisplpayJourney(t,!0)},Journey.prototype._fetchAndDisplpayJourney=function(e,t){t||new Loader(document.getElementById("journeys")),e._fetchData().then(function(t){return e._setupData(t,e)}).then(e._displayJourney)["catch"](function(e){return t||(new DisplayMessage("danger","Oops! Looks like we were unable to get your new route. Here is your last searched journey instead").setupAction(!1),Controller.showDefaultJourney()),Promise.reject()}).then(function(t){return e._addToDB(t,e)})},Journey.prototype._init=function(){var e=this;return this._savedJourney?void e._displayJourney(this._savedJourney).then(function(t){return e._updateInBackground(t,e)}):void e._checkJourneyInDB(e).then(function(t){t.length>0?e._displayJourney(t[0]).then(function(t){return e._updateInBackground(t,e)}):e._fetchAndDisplpayJourney(e)})},FormController.prototype._setupForm=function(){var e=this;fetch("./assets/data/stations.json").then(function(e){return e.json()}).then(function(e){var t={stations:e},o=MyApp.templates.stations(t),n='<option value="">Search for a station...</option>',r='<option value="geolocation">* Use current location</option>';return document.getElementById("location_from").innerHTML=n+r+o,document.getElementById("location_to").innerHTML=n+o,Promise.resolve()}).then(function(){$("#location_from").selectize({sortField:{field:"text",direction:"asc"},onChange:e._getGeolocation}),$("#location_to").selectize({sortField:{field:"text",direction:"asc"}})})},FormController.prototype._validateGeolocation=function(e){var t=e.coords.latitude,o=e.coords.longitude,n=[51.703462,-.461611],r=[51.706866,.274473],i=[51.397752,-.419039],a=[51.383184,.15637],s=t<n[0]&&t>i[0]&&t<r[0]&&t>r[0],l=o>n[1]&&o<r[1]&&o<i[1]&&o>a[1];return s&&l},FormController.prototype._getGeolocation=function(e){if("geolocation"===e){if(!("geolocation"in navigator))return document.querySelector('.selectize-dropdown-content div[data-value="geolocation"]').style.display="none",void new DisplayMessage("danger","We can't get your current position because your browser doesn't support this feature :(").setupAction(!1);var t=document.querySelector('.selectize-input .item[data-value="geolocation"]');t.innerHTML="Fetching yout current location... (please hold on)",navigator.geolocation.getCurrentPosition(function(e){newJourneyProtype._validateGeolocation(e)?(t.innerHTML="Using current location",document.querySelector("#location_from option[selected]").value=e.coords.latitude+","+e.coords.longitude):(t.innerHTML="Location invalid",document.querySelector('.selectize-dropdown-content div[data-value="geolocation"]').style.display="none",new DisplayMessage("danger","Looks like you are outside London! Try searching for a station instead of using your location").setupAction(!1))},function(e){t.innerHTML="Location not found",new DisplayMessage("danger","There was a problem getting your current location. Try again or select a train station").setupAction(!1)})}},FormController.prototype._handleSubmit=function(e){e.preventDefault();var t=document.getElementById("location_from"),o=document.getElementById("location_to"),n=t.value,r=o.value,i=t.options[t.selectedIndex].text,a=o.options[o.selectedIndex].text;if(!n|!r)return void new DisplayMessage("danger","You need to select both a departure and arrival station").setupAction(!1);var s={fromCoordinates:n,toCoordinates:r,fromName:i,toName:a};new Journey(s),toggleModal()};var newJourneyForm=document.getElementById("new-journey-form"),newJourneyProtype=new FormController(newJourneyForm);